<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="ezechiel-compact.css" media="screen, print" />
  </head>

  <body>

    <!-- The header -->

    <header>

      <div class="recipient">
        <div id="recipient.fullname" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)" >Recipient Name</div>
        <div id="recipient.fulladdress" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)">Recipient Address</div>
      </div>

      <div class="institute" >
				<div class="logo">
		      <img class="image" id="institute.logo" />
				</div>
        <div id="institute.name" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)" >Institute Name</div>
        <div id="institute.fulladdress" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)">Institute Address</div>
      </div>

      <div class="cmo">
        <div id="cmo.unit" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)">Drugs laboratory</div>
        <div id="cmo.fullname" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)" >Chief Medical Officer Name</div>
        <div class="line">
          <div class="label.contact singleLine ellipsis translatable.phone" >Phone:</div>
          <div id="cmo.phone" class="field.expanding singleLine data" contenteditable="true" onInput="inputEvent(this, event)" ></div>
        </div>
        <div class="line">
          <div class="label.contact singleLine ellipsis translatable.fax" >Fax:</div>
          <div id="cmo.fax" class="field.expanding singleLine data" contenteditable="true" onInput="inputEvent(this, event)" ></div>
        </div>
      </div>

      <div class="team">
        <div id="team.name" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)" >Therapeutic Drug Monitoring Unit</div>
        <div id="team.members" class="field.expanding data" contenteditable="true" onInput="inputEvent(this, event)">Members list</div>
        <div class="line">
          <div class="label.contact singleLine ellipsis translatable.phone" >Phone:</div>
          <div id="team.phone" class="field.expanding singleLine data" contenteditable="true" onInput="inputEvent(this, event)" ></div>
        </div>
        <div class="line">
          <div class="label.contact singleLine ellipsis translatable.fax" >Fax:</div>
          <div id="team.fax" class="field.expanding singleLine data" contenteditable="true" onInput="inputEvent(this, event)" ></div>
        </div>
      </div>

		  <div class="reference" >
				<div class="line">
					<div id="translatable.reference" class="label.reference singleLine ellipsis" >Reference:</div>
					<div id="reference" class="field.expanding singleLine ellipsis data" contenteditable="true" onInput="inputEvent(this, event)" ></div>
				</div>
		  </div>

		  <div class="creationDate" >
		    <div id="creation.display" class="field.expanding singleLine ellipsis data" contentEditable="true" onInput="inputEvent(this, event)" >Creation date</div>
		  </div>

    </header>

    <!-- The title section -->

    <div id="titleSection" >
      <div class="line">
        <div id="translatable.customTitle" class="field.title singleLine ellipsis data" contenteditable="true" onInput="inputEvent(this, event)" >Therapeutic Drug Monitoring:</div>
        <div id="treatment.drug" class="field.expanding singleLine ellipsis data"  contenteditable="true" onInput="inputEvent(this, event)" ></div>
      </div>
    </div>

    <!-- The patient section -->

    <section id="patientSection" data-hidden="false" >
      <div class="section.title" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.patient.name" >Patient:</div>
          <div class="section.title.container" >
            <div class="field data" id="patient.fullname" onInput="inputEvent(this, event)" contentEditable="true" ></div>
            <div class="label translatable.id.start" >(ID:</div>
            <div class="field data" id="patient.external" onInput="inputEvent(this, event)" contentEditable="true" ></div>
            <div class="label translatable.id.stop" >)</div>
          </div>
          <div class="label singleLine" id="translatable.patient.birthdate" >Birthdate:</div>
          <div class="field.expanding singleLine ellipsis data" id="patient.birthdate.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
      <div class="section.content" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.patient.gender" >Sex:</div>
          <div class="field.short singleLine data" id="patient.gender.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label.short singleLine ellipsis" id="translatable.patient.age" >Age:</div>
          <div class="field.short singleLine data" id="patient.age" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label.short singleLine ellipsis" id="translatable.patient.weight" >Weight:</div>
          <div class="field.short singleLine data" id="patient.weight" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label.short singleLine ellipsis" id="translatable.patient.gist" >GIST:</div>
          <div class="field.expanding singleLine data" id="patient.gist" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.interpretation.indication" >Indication:</div>
          <div class="field.expanding data" id="interpretation.indication" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.interpretation.comedication" >Comedication:</div>
          <div class="field.expanding data" id="interpretation.comedication" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.interpretation.response" >Response:</div>
          <div class="field.expanding data" id="interpretation.response" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.interpretation.afterEffect" >Toxicities:</div>
          <div class="field.expanding data" id="interpretation.afterEffect" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis translatable.comments" >Comments:</div>
          <div class="field.expanding data" id="interpretation.comments" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
    </section>

    <!-- The sample section -->

    <section id="sampleSection" data-hidden="false" >
      <div class="section.title" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.sample.from" >Sample:</div>
          <div class="section.title.container" >
            <div class="field data" id="sample.date.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
            <div class="label translatable.at" >at</div>
            <div class="field data" id="sample.hour.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
            <div class="label translatable.id.start" >(ID:</div>
            <div class="field data" id="sample.external" onInput="inputEvent(this, event)" contentEditable="true" ></div>
            <div class="label translatable.id.stop" >)</div>
          </div>
          <div class="label" id="translatable.sample.result" >Result:</div>
          <div class="field data" id="treatment.analyte" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="field.expanding singleLine data" id="sample.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
      <div class="section.content" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.dosage.last.date.display" >Last dose:</div>
          <div class="field data" id="dosage.last.date.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label translatable.at" >at</div>
          <div class="field data" id="dosage.last.hour.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label.dosage singleLine ellipsis" id="translatable.dosage.display" >Dosage:</div>
          <div class="field data" id="dosage.dose.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label" id="translatable.dosage.every" >every</div>
          <div class="field data" id="dosage.interval.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label" id="translatable.dosage.since" >since</div>
          <div class="field data" id="dosage.date.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          <div class="label" id="translatable.dosage.route" >Route:</div>
          <div class="field data" id="dosage.intake.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.header singleLine ellipsis translatable.comments" >Comments:</div>
          <div class="field.expanding data" id="sample.comments" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
    </section>

    <!-- The prediction section -->

    <section id="predictionSection" data-hidden="false" >
      <div class="section.title" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.prediction.title" >Prediction:</div>
          <div class="section.title.container" >
            <div class="label" id="translatable.prediction.extrapolated" >Extrapolated trough:</div>
            <div class="field data" id="prediction.extrapolated.display" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          </div>
          <div class="label" id="translatable.prediction.target.residual.best" >Target trough:</div>
          <div class="field.expanding singleline data" id="prediction.target.residual.best" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
      <div class="section.content" >
        <div class="prediction.chart" >
          <img class="image" id="chart.image" />
        </div>
        <div class="prediction.legend" >
          <img class="image" id="chart.legend" />
        </div>
        <div class="prediction.parameters" >
          <table id="parameters.table">
            <tr>
              <th id="translatable.parameters.identifier" ></th>
              <th id="translatable.parameters.population" >Standard</th>
              <th id="translatable.parameters.reference" >A priori</th>
              <th id="translatable.parameters.patient" >A posteriori</th>
            </tr>
          </table>
        </div>
      </div>
    </section>

    <!-- The interpretation section -->

    <section id="interpretationSection" data-hidden="false" >
      <div class="section.title" >
        <div class="line" >
          <div class="label.header singleLine ellipsis" id="translatable.interpretation.title" >Comments:</div>
          <div class="section.title.container" >
            <div class="label" id="translatable.interpretation.author" >Author:</div>
            <div class="field data" id="analyst.fullname" onInput="inputEvent(this, event)" contentEditable="true" ></div>
          </div>
          <div class="label" id="translatable.interpretation.date" >Date:</div>
          <div class="field.expanding singleline ellipsis data" id="interpretation.date" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
      <div class="section.content" >
        <div class="line" >
          <div class="field.expanding data" id="interpretation" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.proposedPosology singleLine ellipsis" id="translatable.interpretation.proposed" >Dosage adjustment proposed:</div>
          <div class="field.expanding singleLine data" id="proposedPosology" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
        <div class="line" >
          <div class="label.nextTDM singleLine ellipsis" id="translatable.interpretation.next" >Next TDM suggested:</div>
          <div class="field.expanding singleLine data" id="nextControl" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
    </section>

    <!-- The references section -->

    <section id="referencesSection" data-hidden="false" >
      <div class="section.content" >
        <div class="line" >
          <div class="label singleLine ellipsis" id="translatable.references" >References:</div>
          <div class="field.expanding data" id="references" onInput="inputEvent(this, event)" contentEditable="true" ></div>
        </div>
      </div>
    </section>

    <!-- The scripts -->

    <!-- <script src="ckeditor/ckeditor.js"></script> -->
    <script type="text/javascript">

      //Temporary disable CKEditor, we need to load the correct field values first
      //CKEDITOR.disableAutoInline = true;

      /********************************************************************************************
      * Global variables
      ********************************************************************************************/

      //The <ID, initFunction> map
      var UPDATER       = {};

      //The display variables
      var NB_DECIMALS   = 2;                //Number of decimals to display

      //The events variables
      var BLOCK_UPDATES = false;            //Ignore all updates

      //The colors variables
      var HIDDEN_FALSE_BACKGROUND = "#FFF";
      var HIDDEN_TRUE_BACKGROUND  = "#d3d3d3";

      /********************************************************************************************
      * Sections functions
      ********************************************************************************************/

      function sectionClicked(elem, e)
      {
        var parent = elem.parentElement;
        var hidden = parent.getAttribute("data-hidden") == "true";

        if (hideSection(parent, !hidden)) {
          return;
        }
        hidden ? Report.Data.showSection(parent.id) : Report.Data.hideSection(parent.id);
      }

      function hideSection(elem, hide)
      {
        title   = document.querySelector("#" + elem.id + " > .section\\.title");
        content = document.querySelector("#" + elem.id + " > .section\\.content");

        if (!document.body.contains(title)) {
          return false;
        }
        if (!document.body.contains(content)) {
          return false;
        }

        content.style.display = hide ? "none" : "";
        content.offsetHeight; //Fix repaint issues

        title.style.background = hide ? HIDDEN_TRUE_BACKGROUND : HIDDEN_FALSE_BACKGROUND;
        elem.setAttribute("data-hidden", hide ? "true" : "false");
      }

      /********************************************************************************************
      * Inputs functions
      ********************************************************************************************/

      function inputEvent(elem, e)
      {
        BLOCK_UPDATES = true;

        Report.Data.setValue(elem.id, elem.innerHTML);
        
        if (elem.id == "institute.name") {
          Report.Data.unsetValue("institute.id");
        }
        if (elem.id == "cmo.fullname") {
          Report.Data.unsetValue("cmo.id");
        }
        if (elem.id == "analyst.fullname") {
          Report.Data.unsetValue("analyst.id");
        }
        if (elem.id == "recipient.fullname") {
          Report.Data.unsetValue("recipient.id");
        }
        if (elem.id.substring(0, 8) == "patient.") {
          Report.Data.unsetValue("patient.id");
        }
        if (elem.id == "translatable.customTitle") {
          initTitleDisplay(true);
        }
        if (elem.id == "treatment.drug") {
          initTitleDisplay(true);
        }

        BLOCK_UPDATES = false;
      }

      /********************************************************************************************
      * Slots functions
      ********************************************************************************************/

      function updateValue(id, value)
      {
        if (BLOCK_UPDATES) {
          return;
        }

        if (UPDATER.hasOwnProperty(id)) {
          UPDATER[id](true);
        } else {
          document.getElementById(id).innerHTML = value;
        }
      }

      function updateImage(id, image)
      {
        if (BLOCK_UPDATES) {
          return;
        }

        image.assignToHTMLImageElement(document.getElementById(id));
      }

      /********************************************************************************************
      * Initialization functions
      ********************************************************************************************/

      function init()
      {
        //Initialize the report
        initStyles();
        initSections();
        initData();

        //Set the values of each data elements
        var dataElements = document.getElementsByClassName("data");
        for (var i = 0; i < dataElements.length; ++i) {
          var dataElement = dataElements[i];
          if (Report.Data.containsValue(dataElement.id)) {
            dataElement.innerHTML = Report.Data.value(dataElement.id)
          }
        }

        //Set the images of each image elements
        var imageElements = document.getElementsByClassName("image");
        for (var i = 0; i < imageElements.length; ++i) {
          var imageElement = imageElements[i];
          if (Report.Data.containsImage(imageElement.id)) {
            Report.Data.image(imageElement.id).assignToHTMLImageElement(imageElement);
          }
        }

        //Connect the update signals from the model
        Report.Data.valueChanged.connect(updateValue);
        Report.Data.imageChanged.connect(updateImage);
        Report.Data.valuesReset.connect(init);
        Report.Data.imagesReset.connect(init);
      }

      //Initializes the styles
      function initStyles()
      {
        var sectionTitles = document.getElementsByClassName("section.title");

        if (sectionTitles.length > 0) {
          HIDDEN_FALSE_BACKGROUND = sectionTitles[0].style.background;
        }
      }

      //Initializes the sections
      function initSections()
      {
        var hiddenSections = Report.Data.hiddenSections();

        for (var i = 0; i < hiddenSections.length; ++i) {
          var section = document.getElementById(hiddenSections[i]);

          if (document.body.contains(section)) {
            hideSection(section, true);
          }
        }
      }

      //Initializes the data
      function initData()
      {
        UPDATER.length = 0;

        initInstitute();
        initCMO();
        initTeam();
        initRecipient();
        initCreation();
        initReference();
        initTitle();
        initPatient();
        initSample();
        initPrediction()
        initInterpretation();
      }

      /********************************************************************************************
      * Institute functions
      ********************************************************************************************/

      function initInstitute()
      {
        initInstituteMap();
        initInstituteAddress(false);
      }

      function initInstituteMap()
      {
        UPDATER["institute.address"]  = initInstituteAddress;
        UPDATER["institute.postcode"] = initInstituteAddress;
        UPDATER["institute.city"]     = initInstituteAddress;
        UPDATER["institute.country"]  = initInstituteAddress;
      }

      function initInstituteAddress(reset)
      {
        if (!reset && Report.Data.containsValue("institute.fulladdress")) {
          return;
        }

        var instituteFullAddress = Report.Data.value("institute.address") + "<br>" + 
                                   Report.Data.value("institute.postcode") + " " + 
                                   Report.Data.value("institute.city") + "<br>" + 
                                   Report.Data.value("institute.country");

        setValue("institute.fulladdress", instituteFullAddress);
      }

      /********************************************************************************************
      * Team functions
      ********************************************************************************************/

      function initTeam()
      {
        initTeamMap();
        initTeamMembers(false);
      }

      function initTeamMap()
      {
        UPDATER["team.count"] = initTeamMembers;
      }

      function initTeamMembers(reset)
      {
        if (!reset && Report.Data.containsValue("team.members")) {
          return;
        }

        var teamCount = parseInt(Report.Data.value("team.count"));
        var teamMembers = "";
        for (var i = 0; i < teamCount; ++i) {
          teamMembers += Report.Data.value("team.member" + i + ".title") + " " + 
                         Report.Data.value("team.member" + i + ".firstname") + " " + 
                         Report.Data.value("team.member" + i + ".lastname") + "<br>";
        }
        setValue("team.members", teamMembers);
      }

      /********************************************************************************************
      * Chief Medical Officer (CMO) functions
      ********************************************************************************************/

      function initCMO()
      {
        initCMOMap();
        initCMOName(false);
      }

      function initCMOMap()
      {
        UPDATER["cmo.title"]     = initCMOName;
        UPDATER["cmo.firstname"] = initCMOName;
        UPDATER["cmo.lastname"]  = initCMOName;
      }

      function initCMOName(reset)
      {
        if (!reset && Report.Data.containsValue("cmo.fullname")) {
          return;
        }

        var cmoFullName = Report.Data.value("cmo.title") + " " + 
                          Report.Data.value("cmo.firstname") + " " + 
                          Report.Data.value("cmo.lastname");

        setValue("cmo.fullname", cmoFullName);
      }

      /********************************************************************************************
      * Recipient functions
      ********************************************************************************************/

      function initRecipient()
      {
        initRecipientMap();
        initRecipientName(false);
        initRecipientAddress(false);
      }

      function initRecipientMap()
      {
        UPDATER["recipient.title"]     = initRecipientName;
        UPDATER["recipient.firstname"] = initRecipientName;
        UPDATER["recipient.lastname"]  = initRecipientName;
        UPDATER["recipient.address"]   = initRecipientAddress;
        UPDATER["recipient.postcode"]  = initRecipientAddress;
        UPDATER["recipient.city"]      = initRecipientAddress;
        UPDATER["recipient.country"]   = initRecipientAddress;
      }

      function initRecipientName(reset)
      {
        if (!reset && Report.Data.containsValue("recipient.fullname")) {
          return;
        }

        var recipientFullName = Report.Data.value("recipient.title") + " " + 
                                Report.Data.value("recipient.firstname") + " " + 
                                Report.Data.value("recipient.lastname");

        setValue("recipient.fullname", recipientFullName);
      }

      function initRecipientAddress(reset)
      {
        if (!reset && Report.Data.containsValue("recipient.fulladdress")) {
          return;
        }

        var recipientFullAddress = Report.Data.value("recipient.address") + "<br>" + 
                                   Report.Data.value("recipient.postcode") + " " + 
                                   Report.Data.value("recipient.city") + "<br>" + 
                                   Report.Data.value("recipient.country");

        setValue("recipient.fulladdress", recipientFullAddress);
      }

      /********************************************************************************************
      * Creation date functions
      ********************************************************************************************/

      function initCreation()
      {
        initCreationMap();
        initCreationDisplay(false);
      }

      function initCreationMap()
      {
        UPDATER["creation"] = initCreationDisplay;
      }

      function initCreationDisplay(reset)
      {
        disableEdition("creation.display");
        disableEdition("interpretation.date");

        var creationDate = moment(new Date(Report.Data.value("creation")));
        if (!creationDate.isValid()) {
          creationDate = moment();
        }

        var city;
        if (Report.Data.containsValue("institute.city")) {
          city = Report.Data.value("institute.city") + ", ";
        } else if (Report.Data.containsValue("analyst.city")) {
          city = Report.Data.value("analyst.city") + ", ";
        } else if (Report.Data.containsValue("cmo.city")) {
          city = Report.Data.value("cmo.city") + ", ";
        } else {
          city = "";
        }

        creationDate.locale(Report.Data.value("language"));
        Report.Data.setValue("creation.display", city + creationDate.format('LL'));
        Report.Data.setValue("interpretation.date", creationDate.format('L'));
      }

      /********************************************************************************************
      * Reference functions
      ********************************************************************************************/

      function initReference()
      {
        initReferenceDisplay();
      }

      function initReferenceDisplay()
      {
        if (!isEmpty(Report.Data.value("reference"))) {
          disableEdition("reference");
        }
      }

      /********************************************************************************************
      * Title functions
      ********************************************************************************************/

      function initTitle()
      {
        initTitleMap();
        initTitleDisplay(false);
        initTreatmentDisplay(false);
      }

      function initTitleMap() {
        UPDATER["title"]          = initTitleDisplay;
        UPDATER["treatment.drug"] = initTreatmentDisplay;
      }

      function initTreatmentDisplay(reset)
      {
        if (Report.Data.containsValue("treatment.drug")) {
          initTitleDisplay(true);

          Report.Data.setValue("treatment.analyte", toHtml(Report.Data.value("treatment.drug")));

          disableEdition("treatment.drug");
          disableEdition("treatment.analyte");
        }
      }

      function initTitleDisplay(reset)
      {
        if (!reset && Report.Data.containsValue("title.custom")) {
          document.querySelector("#translatable\\.customTitle").innerHTML = Report.Data.value("title.custom");
          return;
        }

        Report.Data.setValue("title.custom", document.querySelector("#translatable\\.customTitle").innerHTML);

        var title = Report.Data.value("title.custom");
        if (Report.Data.containsValue("treatment.drug")) {
           title += " " + Report.Data.value("treatment.drug");
        }

        setValue("title", title);
      }

      /********************************************************************************************
      * Patient functions
      ********************************************************************************************/

      function initPatient()
      {
        initPatientMap();
        initPatientName(false);
        initPatientBirthdate(false);
        initPatientGender(false);
        initPatientId(false);
        initPatientCovariates(false);
      }

      function initPatientMap()
      {
        UPDATER["patient.firstname"] = initPatientName;
        UPDATER["patient.lastname"]  = initPatientName;
        UPDATER["patient.birthdate"] = initPatientBirthdate;
        UPDATER["patient.age"]       = initPatientBirthdate;
        UPDATER["patient.gender"]    = initPatientGender;
        UPDATER["covariates.count"]  = initPatientCovariates;
      }

      function initPatientName(reset)
      {
        if (!reset && Report.Data.containsValue("patient.fullname")) {
          disableEdition("patient.fullname");
          return;
        }

        var patientFullName = Report.Data.value("patient.lastname") + ", " + 
                              Report.Data.value("patient.firstname");

        if (!isEmpty(patientFullName)) {
          disableEdition("patient.fullname");
          Report.Data.setValue("patient.fullname", toHtml(patientFullName));
        }
      }

      function initPatientBirthdate(reset)
      {
        if (!reset && Report.Data.containsValue("patient.birthdate.display") && Report.Data.containsValue("patient.age")) {
          disableEdition("patient.birthdate.display");
          disableEdition("patient.age");
          return;
        }

        var birthdate = moment(new Date(Report.Data.value("patient.birthdate")));
        if (!birthdate.isValid()) {
          return;
        }

        disableEdition("patient.birthdate.display");
        birthdate.locale(Report.Data.value("language"));
        Report.Data.setValue("patient.birthdate.display", birthdate.format('L'));
        
        var age = moment().diff(birthdate, 'years');
        if (age < 0) {
          return;
        }

        disableEdition("patient.age");
        Report.Data.setValue("patient.age", age + "yr");
      }

      function initPatientGender(reset)
      {
        if (!reset && Report.Data.containsValue("patient.gender.display")) {
          disableEdition("patient.gender.display");
          return;
        }

        if (!Report.Data.containsValue("patient.gender")) {
          return;
        }

        disableEdition("patient.gender.display");
        Report.Data.setValue("patient.gender.display", Report.Data.value("patient.gender") === "male" ? "Male" : "Female");
      }

      function initPatientId()
      {
        if (!isEmpty(Report.Data.value("patient.external"))) {
          disableEdition("patient.external");
        }
      }

      function initPatientCovariates(reset)
      {
        if (!reset && Report.Data.containsValue("patient.weight") && Report.Data.containsValue("patient.gist")) {
          disableEdition("patient.weight");
          disableEdition("patient.gist");
          return;
        }

        var weight = "";
        var gist   = "";

        var covariatesCount = parseInt(Report.Data.value("covariates.count"));

        if (isNaN(covariatesCount) || covariatesCount == 0) {
          return;
        }

        for (var i = 0; i < covariatesCount; ++i) {
          var covariate = "covariates.covariate" + i;
          var unit      = " " + Report.Data.value(covariate + ".unit");
          var type      = Report.Data.value(covariate + ".type");
          var raw       = Report.Data.value(covariate + ".value");
          var value     = "";

          if (type == "bool") {
            if (parseFloat(raw) == 0) {
              value = "No";
            } else if (parseFloat(raw) == 1) {
              value = "Yes";
            } else {
              value = "Unknown";
            }
          } else if (type == "int") {
            value = parseInt(raw) + unit;
          } else {
            value = format(raw) + unit;
          }

          if (Report.Data.value(covariate + ".identifier") === "weight") {
            weight = value;
          }
          if (Report.Data.value(covariate + ".identifier") === "gist") {
            gist = value;
          }
        }

        if (!reset && Report.Data.containsValue("patient.weight")) {
          disableEdition("patient.weight");
        } else if (!isEmpty(weight)) {
          disableEdition("patient.weight");
          Report.Data.setValue("patient.weight", weight);
        }

        if (!reset && Report.Data.containsValue("patient.gist")) {
          disableEdition("patient.gist");
        } else {
          disableEdition("patient.gist");
          Report.Data.setValue("patient.gist", isEmpty(gist) ? "N/A" : gist);
        }
      }

      /********************************************************************************************
      * Sample functions
      ********************************************************************************************/

      function initSample()
      {
        initSampleMap();
        initSampleId();
        initSampleDate(false);
        initSampleDisplay(false);
        initDosageLast(false);
        initDosageDisplay(false);
        initDosageInterval(false);
        initDosageDate(false);
        initDosageIntake(false);
      }

      function initSampleMap()
      {
        UPDATER["sample.date"]           = initSampleDate;
        UPDATER["sample.value"]          = initSampleDisplay;
        UPDATER["sample.unit"]           = initSampleDisplay;
        UPDATER["dosage.take.last"]      = initDosageLast;
        UPDATER["dosage.dose.value"]     = initDosageDisplay;
        UPDATER["dosage.dose.unit"]      = initDosageDisplay;
        UPDATER["dosage.interval.value"] = initDosageInterval;
        UPDATER["dosage.interval.unit"]  = initDosageInterval;
        UPDATER["dosage.take.first"]     = initDosageDate;
        UPDATER["dosage.intake"]         = initDosageIntake;
        UPDATER["dosage.infusion.value"] = initDosageIntake;
        UPDATER["dosage.infusion.unit"]  = initDosageIntake;
      }

      function initSampleId()
      {
        if (!isEmpty(Report.Data.value("sample.external"))) {
          disableEdition("sample.external");
        }
      }

      function initSampleDate(reset)
      {
        if (!reset && Report.Data.containsValue("sample.date.display") && Report.Data.containsValue("sample.hour.display")) {
          disableEdition("sample.date.display");
          disableEdition("sample.hour.display");
          return;
        }

        var sampleDate = moment(new Date(Report.Data.value("sample.date")));

        if (sampleDate.isValid()) {
          sampleDate.locale(Report.Data.value("language"));

          disableEdition("sample.date.display");
          disableEdition("sample.hour.display");

          Report.Data.setValue("sample.date.display", sampleDate.format('L'));
          Report.Data.setValue("sample.hour.display", sampleDate.format('HH:mm'));
        }
      }

      function initSampleDisplay(reset)
      {
        if (!reset && Report.Data.containsValue("sample.display")) {
          disableEdition("sample.display");
          return;
        }

        var sampleValue = Report.Data.value("sample.value");

        if (!isEmpty(sampleValue)) {
          var sample = format(sampleValue) + " " + Report.Data.value("sample.unit");
          disableEdition("sample.display");
          Report.Data.setValue("sample.display", sample);
        }
      }

      function initDosageLast(reset)
      {
        if (!reset && Report.Data.containsValue("dosage.last.date.display") && Report.Data.containsValue("dosage.last.hour.display")) {
          disableEdition("dosage.last.date.display");
          disableEdition("dosage.last.hour.display");
          return;
        }

        var lastDoseDate = moment(new Date(Report.Data.value("dosage.take.last")));

        if (lastDoseDate.isValid()) {
          lastDoseDate.locale(Report.Data.value("language"));

          disableEdition("dosage.last.date.display");
          disableEdition("dosage.last.hour.display");

          Report.Data.setValue("dosage.last.date.display", lastDoseDate.format('L'));
          Report.Data.setValue("dosage.last.hour.display", lastDoseDate.format('HH:mm'));
        }
      }

      function initDosageDisplay(reset) {
        if (!reset && Report.Data.containsValue("dosage.dose.display")) {
          disableEdition("dosage.dose.display");
          return;
        }

        var dosageDisplay  = Report.Data.value("dosage.dose.value") + " " +
                             Report.Data.value("dosage.dose.unit");

        if (!isEmpty(dosageDisplay)) {
          disableEdition("dosage.dose.display");
          Report.Data.setValue("dosage.dose.display", toHtml(dosageDisplay));
        }        
      }

      function initDosageInterval(reset) {
        if (!reset && Report.Data.containsValue("dosage.interval.display")) {
          disableEdition("dosage.interval.display");
          return;
        }

        var dosageInterval = Report.Data.value("dosage.interval.value") +
                             Report.Data.value("dosage.interval.unit");

        if (!isEmpty(dosageInterval)) {
          disableEdition("dosage.interval.display");
          Report.Data.setValue("dosage.interval.display", toHtml(dosageInterval));
        }        
      }

      function initDosageDate(reset)
      {
        if (!reset && Report.Data.containsValue("dosage.date.display")) {
          disableEdition("dosage.date.display");
          return;
        }

        var dosageDate = moment(new Date(Report.Data.value("dosage.take.first")));

        if (dosageDate.isValid()) {
          disableEdition("dosage.date.display");
          dosageDate.locale(Report.Data.value("language"));
          Report.Data.setValue("dosage.date.display", dosageDate.format('L'));
        }
      }

      function initDosageIntake(reset) {
        if (!reset && Report.Data.containsValue("dosage.intake.display")) {
          disableEdition("dosage.intake.display");
          return;
        }

        var dosageIntake  =  Report.Data.value("dosage.intake");
        var infusionValue =  Report.Data.value("dosage.infusion.value");

        if (!isNaN(parseFloat(infusionValue)) && parseFloat(infusionValue) > 0.0) {
          dosageIntake += " (" + infusionValue + Report.Data.value("dosage.infusion.unit") + ")";
        }

        if (!isEmpty(dosageIntake)) {
          disableEdition("dosage.intake.display");
          Report.Data.setValue("dosage.intake.display", toHtml(dosageIntake));
        }        
      }

      /********************************************************************************************
      * Prediction functions
      ********************************************************************************************/

      function initPrediction()
      {
        initPredictionMap();
        initPredictionExtrapolated(false);
        initPredictionTarget(false);
        initPredictionParameters(false);
      }

      function initPredictionMap()
      {
        UPDATER["concentrations.count"]                = initPredictionExtrapolated;
        UPDATER["concentrations.concentration0.value"] = initPredictionExtrapolated;
        UPDATER["concentrations.concentration0.unit"]  = initPredictionExtrapolated;
        UPDATER["targets.count"]                       = initPredictionTarget;
        UPDATER["parameters.count"]                    = initPredictionParameters;
      }

      function initPredictionExtrapolated(reset)
      {
        if (!reset && Report.Data.containsValue("prediction.extrapolated.display")) {
          disableEdition("prediction.extrapolated.display");
          return;
        }

        var concentrationValue = Report.Data.value("concentrations.concentration0.value");

        if (!isEmpty(concentrationValue)) {
          var extrapolated = format(concentrationValue) + " " + Report.Data.value("concentrations.concentration0.unit");
          disableEdition("prediction.extrapolated.display");
          Report.Data.setValue("prediction.extrapolated.display", extrapolated);
        }
      }

      function initPredictionTarget(reset)
      {
        if (!reset && Report.Data.containsValue("prediction.target.residual.best")) {
          disableEdition("prediction.target.residual.best");
          return;
        }

        var targetsCount = parseInt(Report.Data.value("targets.count"));

        if (isNaN(targetsCount) || targetsCount == 0) {
          return;
        }

        var best = "";

        for (var i = 0; i < targetsCount; ++i) {
          var target = "targets.target" + i;

          if (Report.Data.value(target + ".type") == "Residual") {
            var residualBestValue = Report.Data.value(target + ".value0.best");

            if (!isEmpty(residualBestValue)) {
              var best = format(residualBestValue) + " " + Report.Data.value(target + ".value0.unit");
              break;
            }
          }
        }

        if (!isEmpty(best)) {
          disableEdition("prediction.target.residual.best");
          Report.Data.setValue("prediction.target.residual.best", best);
        }
      }

      function initPredictionParameters(reset)
      {
        var parametersTable = document.getElementById("parameters.table");
        var parametersCount = parseInt(Report.Data.value("parameters.count"));

        if (isNaN(parametersCount) || parametersCount == 0) {
          parametersTable.style.display = 'none';
          return;
        }

        for (var i = 0; i < parametersCount; ++i) {
          var parameter = "parameters.parameter" + i;

          var row = document.createElement("tr");
          parametersTable.appendChild(row);

          var identifierCell = document.createElement("td");
          identifierCell.setAttribute("class", "data");
          identifierCell.setAttribute("id", parameter + ".identifier");

          var populationCell = document.createElement("td");
          populationCell.setAttribute("class", "data");
          populationCell.setAttribute("id", parameter + ".population.display");

          var aprioriCell = document.createElement("td");
          aprioriCell.setAttribute("class", "data");
          aprioriCell.setAttribute("id", parameter + ".reference.display");

          var aposterioriCell = document.createElement("td");
          aposterioriCell.setAttribute("class", "data");
          aposterioriCell.setAttribute("id", parameter + ".patient.display");

          row.appendChild(identifierCell);
          row.appendChild(populationCell);
          row.appendChild(aprioriCell);
          row.appendChild(aposterioriCell);

          var parameterUnit = " " + Report.Data.value(parameter + ".unit");

          if (!Report.Data.containsValue(parameter + ".patient.display")) {
            var aposterioriDisplay = format(Report.Data.value(parameter + ".patient")) + parameterUnit;
            setValue(parameter + ".patient.display", aposterioriDisplay);
          }

          if (!Report.Data.containsValue(parameter + ".reference.display")) {
            var aprioriDisplay = format(Report.Data.value(parameter + ".reference")) + parameterUnit;
            setValue(parameter + ".reference.display", aprioriDisplay);
          }

          if (!Report.Data.containsValue(parameter + ".population.display")) {
            var populationDisplay = format(Report.Data.value(parameter + ".population")) + parameterUnit;
            setValue(parameter + ".population.display", populationDisplay);
          }
        }
      }

      /********************************************************************************************
      * Interpretation functions
      ********************************************************************************************/

      function initInterpretation()
      {
        initInterpretationMap();
        initInterpretationAnalyst(false);
      }

      function initInterpretationMap()
      {
        UPDATER["analyst.title"]     = initInterpretationAnalyst;
        UPDATER["analyst.firstname"] = initInterpretationAnalyst;
        UPDATER["analyst.lastname"]  = initInterpretationAnalyst;
      }
      function initInterpretationAnalyst(reset)
      {
        if (!reset && Report.Data.containsValue("analyst.fullname")) {
          disableEdition("analyst.fullname");
          return;
        }

        var analystFullName = Report.Data.value("analyst.title") + " " + 
                              Report.Data.value("analyst.firstname") + " " + 
                              Report.Data.value("analyst.lastname");

        disableEdition("analyst.fullname");
        setValue("analyst.fullname", analystFullName);
      }

      /********************************************************************************************
      * Utilities functions
      ********************************************************************************************/

      //Fixes the decimals of a number in a string
      function format(value) {
        return parseFloat(value).toFixed(NB_DECIMALS);
      }

      //Disable the edition of the given element
      function disableEdition(id) {
          document.getElementById(id).setAttribute("contentEditable", "false");
      }

      //Check if a value is empty/whitespaces only
      function isEmpty(value) {
        return /^(?:\s|<br>)*$/.test(value);
      }

      //Replace special characters by HTML tags
      function toHtml(value) {
        return String(value).replace(/\n/g, "<br>");
      }

      //Converts a value to HTML and sets it unless it's empty
      function setValue(id, value)
      {
        if (!isEmpty(value)) {
          Report.Data.setValue(id, toHtml(value));
        }
      }

    </script>
  </body>
</html>
